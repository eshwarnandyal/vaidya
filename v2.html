<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Clinical Insight Platform</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load OrbitControls --><script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Load GSAP --><script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <style>
        /* Base styles */
        body {
            /* Changed to allow scrolling for the whole page */
            overflow-y: auto; 
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #0c101c; /* Very Deep Navy Base */
        }

        /* 3D Container */
        #three-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10;
        }

        /* UI Overlay */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            /* Changed from 100vh to min-h-screen to allow content overflow and scrolling */
            min-height: 100vh;
            z-index: 20;
            pointer-events: none;
        }

        .interactive-ui * {
            pointer-events: auto;
        }

        /* --- Custom Spectrum UI Styles V6 (Scrolling & Fixed TTS) --- */

        /* Header Text Styling: Decreased size for professionalism and mobile fit */
        .modern-header-title {
            /* Adjusted size clamping (max 2.8rem) for smaller title */
            font-size: clamp(1.8rem, 5vw, 2.8rem); 
            font-weight: 800;
            line-height: 0.95;
            background: linear-gradient(90deg, #67e8f9, #34d399, #fde047); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 8px rgba(52, 211, 153, 0.4)); 
            transition: all 0.5s ease;
        }
        
        .modern-header-tag {
            background-color: #1e293b; 
            border: 1px solid #0891b2; 
            color: #67e8f9;
            padding: 0.2rem 0.6rem; /* Reduced padding */
            border-radius: 9999px; 
            font-size: 0.75rem; /* Reduced font size */
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* Data Glass Panel */
        .data-glass-panel {
            background-color: rgba(2, 6, 23, 0.9); 
            backdrop-filter: blur(16px);
            border: 1px solid rgba(100, 116, 139, 0.2); 
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8), 0 0 40px rgba(52, 211, 153, 0.1); 
            transition: all 0.3s ease;
        }
        
        /* Highlight Class for Voice Tour */
        .highlight-focus {
            box-shadow: 0 0 15px 5px rgba(255, 255, 0, 0.8), 0 0 30px 10px rgba(255, 165, 0, 0.4) !important;
            border-color: #fde047 !important;
            transform: scale(1.02);
        }

        /* Button Focus Animation (Emerald/Green) */
        @keyframes button-focus {
            0%, 100% {
                box-shadow: 0 0 8px rgba(52, 211, 153, 0.7), 0 0 16px rgba(52, 211, 153, 0.3);
            }
            50% {
                box-shadow: 0 0 12px rgba(52, 211, 153, 1), 0 0 24px rgba(52, 211, 153, 0.6);
            }
        }

        /* Base Button Style: Reduced padding/size */
        .btn-spectrum {
            font-weight: 700;
            letter-spacing: 0.05em;
            transition: all 0.3s ease-out;
            border: none;
            padding: 0.6rem 1.5rem; /* Decreased padding */
            font-size: 0.875rem; /* Standard text size */
            text-transform: uppercase;
            border-radius: 8px;
        }
        /* ... (rest of button styles remain the same) ... */
        .btn-spectrum:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            filter: brightness(1.2);
        }
        
        /* Generate Button (Primary Action - Emerald/Green) */
        .btn-generate {
            background: linear-gradient(90deg, #10b981, #34d399); 
            color: #0c101c; 
            animation: button-focus 3s infinite alternate;
        }

        /* Post Button (Active - Orange/Amber) */
        .btn-post-active {
            background: linear-gradient(90deg, #f59e0b, #ea580c); 
            color: #0c101c;
        }

        /* Inactive/Info Button (Blue Accent) */
        .btn-info {
            background-color: rgba(14, 165, 233, 0.1); 
            border: 1px solid #0ea5e9; 
            color: #0ea5e9;
        }
        
        /* Voice Tour Button (Cyan accent) */
        .btn-tour {
            background-color: rgba(6, 182, 212, 0.1); /* Cyan 600/10 */
            border: 1px solid #06b6d4; /* Cyan 500 border */
            color: #67e8f9; /* Light Cyan text */
            position: relative; /* Needed for spinner placement */
        }
        
        .btn-spectrum:disabled {
            background: #1e293b;
            color: #475569;
            transform: none;
            cursor: not-allowed;
            box-shadow: none;
            animation: none;
        }
        
        #poster-log {
            /* Now just a fixed-height container */
            min-height: 100px; 
            display: flex;
            flex-direction: column;
        }
        
        /* Custom Spinner for loading state */
        .tts-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #67e8f9;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <!-- Gradient Color Overlay -->
    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 15; pointer-events: none; opacity: 0.2;">
        <div class="h-1/2 w-full bg-gradient-to-b from-cyan-900/40 to-transparent"></div>
        <div class="h-1/2 w-full bg-gradient-to-t from-emerald-900/40 to-transparent"></div>
    </div>
    
    <!-- Audio Element for TTS Playback -->
    <audio id="tts-audio" style="display: none;"></audio>
    <!-- Hidden element to show loading state -->
    <div id="tts-loading" class="fixed top-2 right-2 p-2 bg-slate-800/90 rounded-full shadow-lg hidden">
        <div class="flex items-center space-x-2 text-sm text-cyan-300">
            <div class="tts-spinner"></div>
            <span>Generating Voice...</span>
        </div>
    </div>

    <!-- 3D Container --><div id="three-container"></div>

    <!-- UI Overlay --><div id="overlay">
        <div class="p-6 md:p-10 h-full flex flex-col">

            <!-- 1. Header and Status Terminal -->
            <div class="interactive-ui flex-shrink-0">
                <!-- Top Tagline -->
                <p class="modern-header-tag w-fit mb-3">
                    CLINICAL AI INSIGHTS
                </p>

                <div class="flex flex-col justify-start items-start">
                    <!-- Updated Smaller Header Text -->
                    <h1 id="header-title" class="modern-header-title">
                        AI POSTER <br><span class="text-white">GENERATOR</span>
                    </h1>
                </div>

                <!-- Status Display Terminal (Layout Adjusted for User Request) -->
                <div class="mt-4 md:mt-8 flex flex-col md:flex-row justify-between items-start">
                    
                    <!-- Time and Date Display (MOVED UP per request) -->
                    <div id="status-display" class="data-glass-panel p-4 text-right text-white w-full md:w-auto mb-4 md:mb-0 order-1">
                        <span id="current-day-time" class="text-base font-mono leading-none text-amber-400"></span>
                        
                        <div class="text-sm font-mono text-cyan-300 mt-1">
                            <span class="opacity-70">INSIGHT CYCLE </span>
                            <span id="day-of-year" class="font-extrabold text-yellow-400"></span>
                        </div>
                    </div>

                    <!-- Daily Event / Topic Display -->
                    <div id="topic-display" class="data-glass-panel p-4 text-left text-white w-full md:w-fit order-2">
                        <p class="text-sm font-mono text-cyan-300">CURRENT CYCLE PRIORITY</p>
                        <p id="daily-topic-title" class="text-base font-extrabold text-yellow-400 mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- 2. Main Log / Poster Display Area -->
            <!-- Note: This area is inside the scrollable container -->
            <div class="interactive-ui flex justify-center w-full py-4">
                <!-- Inner Log Panel -->
                <div id="poster-log" class="w-full max-w-4xl data-glass-panel p-8 transition duration-500 text-base">
                    
                    <!-- Activity Feed Header -->
                    <h2 id="log-header" class="text-lg font-semibold text-sky-400 mb-4 border-b border-slate-700 pb-2">Activity Feed (Last 3 Messages)</h2>
                    
                    <!-- Log Message Wrapper -->
                    <div id="log-message-wrapper">
                        <!-- Initial message placeholder -->
                    </div>

                    <!-- Poster Card (Hidden by default) -->
                    <div id="poster-card" class="mt-6 p-5 data-glass-panel shadow-2xl bg-indigo-900/40 hidden">
                        <h3 class="font-extrabold text-xl text-yellow-300 mb-2" id="poster-title"></h3>
                        <p class="text-sm text-gray-100" id="poster-summary"></p>
                        <p class="text-xs text-amber-500 mt-4 font-semibold" id="poster-status"></p>
                    </div>
                </div>
            </div>


            <!-- 3. Command Interface (Shrinks 0) -->
            <div class="interactive-ui flex justify-center flex-shrink-0 pt-4 pb-10">
                <div id="button-panel" class="flex flex-wrap justify-center gap-3 data-glass-panel p-4 md:p-6">
                    <button id="generate-button" onclick="handleCommand('generate')" class="btn-spectrum btn-generate">
                        GENERATE DAILY INSIGHT
                    </button>
                    <button id="post-button" onclick="handleCommand('post')" class="btn-spectrum btn-info" disabled>
                        VALIDATE & SHARE
                    </button>
                    <button onclick="handleCommand('info')" class="btn-spectrum btn-info">
                        VIEW TOPIC DETAILS
                    </button>
                    <button id="tour-button" onclick="handleCommand('tour')" class="btn-spectrum btn-tour">
                        <span id="tour-button-text">VOICE TOUR</span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Firebase Globals (Retained for environment compatibility) ---
        // These are defined for the canvas environment but not used in this specific app
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- UI Elements ---
        const logMessageWrapperEl = document.getElementById('log-message-wrapper');
        const posterCardEl = document.getElementById('poster-card');
        const posterTitleEl = document.getElementById('poster-title');
        const posterSummaryEl = document.getElementById('poster-summary');
        const posterStatusEl = document.getElementById('poster-status');
        const postButton = document.getElementById('post-button');
        const generateButton = document.getElementById('generate-button');
        const tourButton = document.getElementById('tour-button');
        const tourButtonText = document.getElementById('tour-button-text');
        const dailyTopicTitleEl = document.getElementById('daily-topic-title');
        const ttsAudio = document.getElementById('tts-audio');
        const ttsLoading = document.getElementById('tts-loading');


        // --- Application State ---
        const state = {
            posterGenerated: false,
            currentPoster: null,
            dayOfYear: getDayOfYear(),
            isTourRunning: false,
            currentCameraZ: 4, 
            apiKey: "", // API key remains empty string as per instructions
        };
        
        // --- Utility Functions ---

        function getDayOfYear() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        function updateTimeDisplay() {
            const now = new Date();
            const fullDate = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
            const fullTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

            document.getElementById('current-day-time').innerHTML = 
                `<span class="text-cyan-300">${fullDate}</span><br>${fullTime}`;
        }

        function getDailyEvent(dayOfYear) {
            const themes = [
                { title: "OMEGA-3 BIOAVAILABILITY PROTOCOL", theme: "A clinical review of EPA/DHA requirements for neurocognitive stability and cardiovascular health. Focus: Dosage, source quality, and cellular absorption rates." },
                { title: "ADVANCED METABOLIC FLEXIBILITY", theme: "Strategies for optimizing mitochondrial function and shifting fuel sources for sustained energy and weight management. Focus: Time-restricted feeding and substrate cycling." },
                { title: "NEURAL PLASTICITY & COGNITIVE RESERVE", theme: "Techniques for enhancing brain plasticity through targeted cognitive training and environmental enrichment. Focus: BDNF activation and novel learning strategies." },
                { title: "EPIGENETIC OPTIMIZATION: LIFESTYLE TRIGGERS", theme: "Analyzing the influence of stress, diet, and environment on gene expression and cellular aging. Focus: Methylation support and protective nutrient intake." },
                { title: "STRESS HORMONE REGULATION (HPA Axis)", theme: "A deep dive into cortisol rhythms and effective methods for modulating the Hypothalamic-Pituitary-Adrenal axis to improve resilience and sleep." },
                { title: "MICROBIOME DIVERSITY MAPPING", theme: "Guidelines for fostering a robust and diverse gut microbial community for immune system priming and neurotransmitter synthesis." },
                { title: "IMMUNE SYSTEM PHAGOCYTOSIS EFFICIENCY", theme: "Research into boosting macrophage and dendritic cell activity through targeted nutrient complexes and rest cycles." },
                { title: "CELLULAR AUTOPHAGY ENHANCEMENT", theme: "Optimization of the body's natural cleansing process for disease prevention and longevity. Focus: Intermittent fasting and specific phytochemicals." },
            ];
            const index = (dayOfYear - 1) % themes.length; 
            return themes[index];
        }

        /** Helper for creating a promise that resolves after a delay (simulating speech time) */
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        // --- TTS Helper Functions ---

        // Converts Base64 string to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Converts 16-bit signed PCM raw data to a WAV file Blob
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            
            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');
            
            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // ChunkSize
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, 1, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * 2, true); // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true); // BlockAlign (NumChannels * BitsPerSample/8)
            view.setUint16(34, 16, true); // BitsPerSample
            
            // Data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true); // Data size

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        /** Plays the generated WAV audio from a Blob */
        function playAudio(wavBlob) {
            const audioUrl = URL.createObjectURL(wavBlob);
            ttsAudio.src = audioUrl;
            
            return new Promise((resolve) => {
                // We resolve on play attempt to prevent indefinite blocking if autoplay is denied
                ttsAudio.play().then(() => {
                    ttsAudio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    };
                }).catch(e => {
                    // CRITICAL UPDATE: Handle Autoplay block explicitly
                    console.error("Audio playback error:", e);
                    updateLog("<span class='text-red-400 font-bold'>Playback Error:</span> Audio autoplay may be blocked by your browser (usually requires user interaction). Please check the console for details.");
                    URL.revokeObjectURL(audioUrl);
                    resolve(); // Resolve anyway to proceed with the tour
                });
            });
        }
        
        /** Calls the Gemini TTS API with exponential backoff */
        async function getTtsAudio(text, retryCount = 0) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${state.apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // Using a firm, professional voice
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retryCount < 3) {
                        const delayTime = Math.pow(2, retryCount) * 1000;
                        await delay(delayTime);
                        return getTtsAudio(text, retryCount + 1);
                    }
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    
                    return pcmToWav(pcm16, sampleRate);
                }
                
                throw new Error("Invalid audio response format or missing audio data.");

            } catch (error) {
                console.error("TTS Generation Error:", error);
                updateLog(`<span class='text-red-400 font-bold'>TTS API Error:</span> Failed to generate audio data. Check console.`);
                // Return a dummy object to prevent app crash if API fails
                return new Blob([], { type: 'audio/wav' });
            }
        }

        // --- UI Update Functions ---

        function updateUI() {
            document.getElementById('day-of-year').textContent = `Day ${state.dayOfYear} of Year`;

            const event = getDailyEvent(state.dayOfYear);
            dailyTopicTitleEl.textContent = event.title;

            const tourActive = state.isTourRunning;
            
            postButton.disabled = !state.posterGenerated || tourActive;
            tourButton.disabled = tourActive;
            generateButton.disabled = tourActive;

            // Handle tour button text and spinner
            if (tourActive) {
                tourButtonText.innerHTML = '<div class="tts-spinner mr-2"></div> TOUR INITIATED...';
            } else {
                tourButtonText.textContent = 'VOICE TOUR';
            }
            
            // Manage button classes for active/inactive state
            postButton.classList.remove('btn-post-active', 'btn-info');
            
            if (state.posterGenerated) {
                postButton.classList.add('btn-post-active');
            } else {
                postButton.classList.add('btn-info');
            }

            // Remove previous highlights
            document.querySelectorAll('.highlight-focus').forEach(el => el.classList.remove('highlight-focus'));
        }

        function updateLog(message) {
            const newMessageEl = document.createElement('p');
            newMessageEl.className = 'text-gray-300 mb-1';
            newMessageEl.innerHTML = `<span class="text-cyan-400 mr-2">â€¢</span> ${message}`;
            
            while (logMessageWrapperEl.children.length >= 3) {
                logMessageWrapperEl.removeChild(logMessageWrapperEl.lastChild);
            }
            logMessageWrapperEl.prepend(newMessageEl);
        }

        function displayPoster() {
            if (state.currentPoster) {
                posterTitleEl.textContent = state.currentPoster.title;
                posterSummaryEl.textContent = state.currentPoster.theme;
                posterStatusEl.textContent = 'STATUS: Insight Draft Complete. Ready for clinical review and sharing.';
                posterCardEl.classList.remove('hidden');

                gsap.from(posterCardEl, {
                    y: 15,
                    opacity: 0,
                    duration: 0.5,
                    ease: 'power2.out'
                });
            } else {
                posterCardEl.classList.add('hidden');
            }
        }

        // --- Voice Tour Logic (Pre-scripted and TTS-enabled) ---

        // ************** UPDATED: Stronger, Professional Script **************
        const tourSteps = [
            { id: 'header-title', 
              text: "This is the **Quantum-AI Analysis Engine**, deployed for strategic health data synthesis. Our objective is to transition from reactive diagnostics to proactive, predictive modeling.", 
              duration: 6000 
            },
            { id: 'status-display', 
              text: "The **Operational Timeline** tracks System Epoch and Insight Cycle progression, providing critical context for data integrity and real-time mission parameters.", 
              duration: 5000 
            },
            { id: 'topic-display', 
              text: "The **Cycle Priority Module** identifies and locks onto a specific, high-value clinical vector, ensuring all subsequent AI processing is targeted for maximum analytical yield.", 
              duration: 6500 
            },
            { id: 'log-header', 
              text: "The **Analysis Log** serves as the immutable record of system actions, reporting on data ingestion, model execution, and final output generation with full transparency.", 
              duration: 6000 
            },
            { id: 'button-panel', 
              text: "The **Command Suite** grants executive control: **Generate Daily Insight** initiates the deep-dive analysis. **Validate and Share** commits the verified insight to the global network. Proceed with command execution.", 
              duration: 8500 
            },
            { id: 'tour-button', 
              text: "System check complete. All operational modules are green. The platform is now fully engaged and awaiting primary command input. Initiate analysis at your discretion.",
              duration: 6000 
            }
        ];
        // ********************************************************************

        function resetCamera() {
            gsap.to(camera.position, {
                x: 0,
                y: 1.5,
                z: state.currentCameraZ, 
                duration: 1.5,
                ease: "power2.inOut"
            });
            controls.autoRotate = true; 
        }
        
        function zoomToElement(elementId) {
            const targetElement = document.getElementById(elementId);
            document.querySelectorAll('.highlight-focus').forEach(el => el.classList.remove('highlight-focus'));
            if (targetElement) {
                targetElement.classList.add('highlight-focus');
                // Ensure the focused element is visible if the page is scrolled
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            if (earthMesh) {
                gsap.to(camera.position, {
                    x: 0,
                    y: 0.5,
                    z: 2.5, 
                    duration: 1.0,
                    ease: "power2.inOut"
                });
                controls.autoRotate = false; 
            }
        }
        
        async function startVoiceTour() {
            if (state.isTourRunning) return;

            state.isTourRunning = true;
            updateUI();
            
            updateLog(`[TOUR] Executing Voice Tour sequence (online generation enabled)...`);
            resetCamera();
            await delay(1500); // Initial camera move delay

            for (const step of tourSteps) {
                updateLog(`[TOUR] <span class="text-yellow-300">Highlighting: ${step.id.replace(/-/g, ' ').toUpperCase()}</span>`);
                zoomToElement(step.id);
                
                // 1. Show loading indicator and generate TTS audio
                ttsLoading.classList.remove('hidden');
                
                // Remove Markdown style bolding from the text before sending to API
                const cleanText = step.text.replace(/\*\*/g, ''); 
                const audioBlob = await getTtsAudio(cleanText);
                
                ttsLoading.classList.add('hidden');

                // 2. Play audio and log event
                if (audioBlob.size > 0) {
                    updateLog(`[VOICE SCRIPT] Playing: "${step.text}"`);
                    playAudio(audioBlob); 
                } else {
                    updateLog(`[VOICE SCRIPT] Text: "${step.text}" <span class="text-red-400">(Playback failed, using text-based duration.)</span>`);
                }
                
                // 3. Wait for the simulated duration (used for reliable UI progression)
                await delay(step.duration); 
            }

            // Final step: Reset
            updateLog(`[TOUR] Sequence complete. System returning to standby mode.`);
            resetCamera();
            document.querySelectorAll('.highlight-focus').forEach(el => el.classList.remove('highlight-focus'));

            state.isTourRunning = false;
            updateUI();
        }

        // --- Command Handlers ---

        function handleCommand(command) {
            if (state.isTourRunning) {
                updateLog("<span class='text-red-400'>Error: Cannot execute command while Voice Tour is active.</span>");
                return;
            }
            
            if (command !== 'tour') {
                if (earthMesh) {
                    gsap.to(earthMesh.rotation, { y: earthMesh.rotation.y + Math.PI / 8, duration: 0.3, ease: 'power1.out' });
                }
                gsap.to(camera.position, { z: camera.position.z - 0.2, duration: 0.15, yoyo: true, repeat: 1, ease: 'power1.out' });
            }

            switch (command) {
                case 'generate': generatePoster(false, true); break;
                case 'post': postPoster(); break;
                case 'info': showDailyInfo(); break;
                case 'tour': startVoiceTour(); break;
            }
            updateUI();
        }

        function generatePoster(silent = false, showSuccess = false) {
            const event = getDailyEvent(state.dayOfYear);
            state.currentPoster = event;
            state.posterGenerated = true;

            if (showSuccess) {
                 updateLog(`<span class="text-yellow-300">New Insight Generated:</span> <span class="text-emerald-400 font-bold">${event.title}</span>. Review the card below.`);
            } else if (!silent) {
                updateLog(`Data Core is processing the request. Running clinical topic analysis.`);
            }
            displayPoster();
        }

        function postPoster() {
            if (!state.posterGenerated) {
                updateLog("<span class='text-red-400'>Error: Transmission failure. Insight not yet generated.</span>");
                return;
            }

            updateLog(`<span class="text-amber-500 font-bold">Validation Successful:</span> Insight "${state.currentPoster.title}" has been shared to the <span class="text-cyan-400">Clinical Network Archive</span>.`);
            
            gsap.to(earthGlow.material, { 
                opacity: 0.8, 
                duration: 0.2, 
                yoyo: true, 
                repeat: 3, 
                ease: 'power1.inOut',
                onComplete: () => { earthGlow.material.opacity = 0.15; }
            });

            gsap.to(posterCardEl, {
                opacity: 0,
                y: -10,
                duration: 0.4,
                onComplete: () => {
                    state.posterGenerated = false;
                    state.currentPoster = null;
                    posterStatusEl.textContent = 'STATUS: System reset for next cycle.';
                    posterCardEl.classList.add('hidden');
                    posterCardEl.style.opacity = 1; 
                    updateUI();
                }
            });
        }
        
        function showDailyInfo() {
            const event = getDailyEvent(state.dayOfYear);
            
            updateLog(`<span class="text-cyan-400">Topic Priority for Cycle ${state.dayOfYear}:</span> <span class="text-yellow-300 font-bold">${event.title}</span>. Detailed Focus: ${event.theme}`);
            
            if (!state.posterGenerated) {
                posterCardEl.classList.add('hidden');
            }
        }

        // --- Three.js Setup ---
        let scene, camera, renderer, controls, earthMesh, cloudsMesh, earthGlow, cityLightsMesh, asteroids = []; 
        const threeContainer = document.getElementById('three-container');
        const textureLoader = new THREE.TextureLoader(); 

        function createEarthGlow() {
            const glowGeometry = new THREE.SphereGeometry(1.07, 64, 64);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: 0x0ea5e9, 
                transparent: true,
                opacity: 0.15,
                blending: THREE.AdditiveBlending, 
                side: THREE.BackSide 
            });
            earthGlow = new THREE.Mesh(glowGeometry, glowMaterial);
            scene.add(earthGlow);
        }

        function createAsteroids() {
            const asteroidCount = 100;
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x94a3b8, 
                flatShading: true,
                specular: 0xffffff,
                shininess: 3
            }); 

            for (let i = 0; i < asteroidCount; i++) {
                const geo = new THREE.DodecahedronGeometry(THREE.MathUtils.randFloat(0.05, 0.2), 0);
                const asteroid = new THREE.Mesh(geo, material.clone());
                
                const distance = THREE.MathUtils.randFloat(8, 50);
                const phi = Math.random() * Math.PI * 2;
                const theta = Math.random() * Math.PI;

                asteroid.position.setFromSphericalCoords(distance, theta, phi);
                asteroid.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
                
                asteroid.userData.rotationSpeed = new THREE.Vector3(
                    THREE.MathUtils.randFloat(-0.002, 0.002),
                    THREE.MathUtils.randFloat(-0.002, 0.002),
                    THREE.MathUtils.randFloat(-0.002, 0.002)
                );

                scene.add(asteroid);
                asteroids.push(asteroid);
            }
        }


        function initThreeJS() {
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(60, threeContainer.clientWidth / threeContainer.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5, state.currentCameraZ); 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight);
            threeContainer.appendChild(renderer.domElement);
            renderer.setClearColor(0x000000, 0);

            // Lights
            const hemisphereLight = new THREE.HemisphereLight(0x0ea5e9, 0x10b981, 3); 
            scene.add(hemisphereLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 5); 
            directionalLight.position.set(10, 5, 5); 
            scene.add(directionalLight);
            const backLight = new THREE.DirectionalLight(0xf59e0b, 2.5);
            backLight.position.set(-10, -5, -10);
            scene.add(backLight);


            // Earth Globe (Textures are loaded from external URLs - necessary for visual)
            const earthGeometry = new THREE.SphereGeometry(1, 64, 64);
            const earthMaterial = new THREE.MeshPhongMaterial({
                map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
                bumpMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_bump_2048.jpg'),
                bumpScale: 0.1, 
                specularMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_specular_2048.jpg'),
                shininess: 18 
            });
            earthMesh = new THREE.Mesh(earthGeometry, earthMaterial);
            scene.add(earthMesh);

            // City Lights
            const cityLightsMaterial = new THREE.MeshBasicMaterial({
                map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_lights_2048.png'),
                blending: THREE.AdditiveBlending, 
                transparent: true,
                opacity: 1.0, 
            });
            cityLightsMesh = new THREE.Mesh(earthGeometry, cityLightsMaterial);
            cityLightsMesh.scale.set(1.0001, 1.0001, 1.0001); 
            earthMesh.add(cityLightsMesh);

            // Earth Glow
            createEarthGlow();

            // Clouds Layer 
            const cloudsGeometry = new THREE.SphereGeometry(1.008, 64, 64);
            const cloudsMaterial = new THREE.MeshPhongMaterial({
                map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png'),
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending
            });
            cloudsMesh = new THREE.Mesh(cloudsGeometry, cloudsMaterial);
            earthMesh.add(cloudsMesh); 

            // Starry Background
            const starsGeometry = new THREE.SphereGeometry(90, 32, 32); 
            const starsMaterial = new THREE.MeshBasicMaterial({
                map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/galaxy.jpg'), 
                side: THREE.BackSide 
            });
            const stars = new THREE.Mesh(starsGeometry, starsMaterial);
            scene.add(stars);
            
            // Asteroid Field
            createAsteroids();

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.08;
            controls.rotateSpeed = 0.2;
            controls.minDistance = 2.5; 
            controls.maxDistance = 6;
            controls.enablePan = false; 
            controls.autoRotate = true; 
            controls.autoRotateSpeed = 0.05;

            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = threeContainer.clientWidth / threeContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight);
        }

        let clock = new THREE.Clock();
        
        function animate() {
            requestAnimationFrame(animate);

            let delta = clock.getDelta();

            if (earthMesh) {
                earthMesh.rotation.y += 0.001 * delta * 60; 
                if (earthGlow) earthGlow.rotation.copy(earthMesh.rotation);

                if (cloudsMesh) {
                    cloudsMesh.rotation.y += 0.0005 * delta * 60; 
                }
            }

            if (asteroids.length > 0) {
                const rotationSpeed = 0.0005 * delta * 60; 
                asteroids.forEach(asteroid => {
                    asteroid.rotation.x += asteroid.userData.rotationSpeed.x;
                    asteroid.rotation.y += asteroid.userData.rotationSpeed.y;
                    asteroid.rotation.z += asteroid.userData.rotationSpeed.z;
                    asteroid.position.applyAxisAngle(new THREE.Vector3(0, 1, 0), rotationSpeed);
                });
            }

            controls.update(); 
            renderer.render(scene, camera);
        }

        // --- Initialization ---

        window.onload = function () {
            initThreeJS();
            animate();
            
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000); 

            updateUI();
            
            // Note: Removed the automatic generatePoster call to ensure the initial log is visible
            updateLog(`[V4.2] High-Impact Voice Tour Enabled. Click 'VOICE TOUR' for executive briefing.`);
        }

    </script>

</body>
</html>